<div class="agents-panel">
  <div class="agents-header">
    <span class="agents-header-title">{{ i18n.t('agents.title') }}</span>
    <button class="agents-close" (click)="agents.toggle()" aria-label="Close agents">&times;</button>
  </div>

  <div class="agents-body">
    <!-- CREATE VIEW -->
    @if (isCreating()) {
      <div class="agents-create">
        <div class="agents-toolbar">
          <button class="agents-toolbar-btn" (click)="cancelCreate()">{{ i18n.t('agents.cancel') }}</button>
        </div>
        <div class="agents-create-form">
          <input
            class="agents-name-input"
            type="text"
            [(ngModel)]="newAgentName"
            [placeholder]="i18n.t('agents.namePlaceholder')" />
          <div class="agents-md-toolbar">
            <button type="button" class="agents-md-toolbar-btn" title="Bold" (click)="insertMarkdown('create','**','**','bold')"><b>B</b></button>
            <button type="button" class="agents-md-toolbar-btn" title="Italic" (click)="insertMarkdown('create','*','*','italic')"><i>I</i></button>
            <button type="button" class="agents-md-toolbar-btn" title="Heading" (click)="insertMarkdown('create','## ','','heading')">H</button>
            <button type="button" class="agents-md-toolbar-btn" title="Link" (click)="insertMarkdown('create','[','](url)','link text')">&#128279;</button>
            <button type="button" class="agents-md-toolbar-btn" title="Bullet list" (click)="insertMarkdown('create','- ','','item')">&#8226;</button>
            <button type="button" class="agents-md-toolbar-btn" title="Numbered list" (click)="insertMarkdown('create','1. ','','item')">1.</button>
            <button type="button" class="agents-md-toolbar-btn" title="Horizontal rule" (click)="insertMarkdown('create','\n---\n','','')">&#8212;</button>
            <button type="button" class="agents-md-toolbar-btn" title="Code" (click)="insertMarkdown('create','`','`','code')">``</button>
            <span class="agents-md-toolbar-sep"></span>
            <button type="button" class="agents-md-toolbar-btn" [class.active]="showCreatePreview()" title="Preview" (click)="toggleCreatePreview()">&#128065;</button>
          </div>
          @if (showCreatePreview()) {
            <div class="agents-md-preview agents-detail-content" [innerHTML]="createPreviewHtml"></div>
          } @else {
            <textarea
              #createTextarea
              class="agents-edit-textarea agents-md-textarea"
              [(ngModel)]="newAgentContent"
              rows="12"></textarea>
          }
          <button
            class="agents-btn-primary"
            [disabled]="!newAgentName.trim() || agents.isSaving()"
            (click)="submitCreate()">
            {{ agents.isSaving() ? i18n.t('agents.saving') : i18n.t('agents.createSave') }}
          </button>
        </div>
      </div>
    }
    <!-- DETAIL VIEW -->
    @else if (agents.selectedAgent(); as agent) {
      <div class="agents-detail">
        @if (showDeleteConfirm()) {
          <div class="agents-delete-bar">
            <span class="agents-delete-msg">{{ i18n.t('agents.deleteConfirm') }}</span>
            <div class="agents-delete-actions">
              <button
                class="agents-btn-danger"
                [disabled]="agents.isDeleting()"
                (click)="confirmDelete()">
                {{ agents.isDeleting() ? i18n.t('agents.deleting') : i18n.t('agents.deleteYes') }}
              </button>
              <button class="agents-btn-secondary" (click)="cancelDelete()">{{ i18n.t('agents.deleteNo') }}</button>
            </div>
          </div>
        }

        <div class="agents-toolbar">
          <button class="agents-toolbar-btn" (click)="goBack()">{{ i18n.t('agents.back') }}</button>
          <div class="agents-toolbar-right">
            @if (!isEditing()) {
              <button class="agents-toolbar-btn agents-toolbar-run" (click)="runAgent(agent)">&#9654; {{ i18n.t('agents.run') }}</button>
              <button class="agents-toolbar-btn" (click)="startEdit()">{{ i18n.t('agents.edit') }}</button>
              <button class="agents-toolbar-btn agents-toolbar-delete" (click)="requestDelete()">{{ i18n.t('agents.delete') }}</button>
            }
          </div>
        </div>

        <div class="agents-detail-name">{{ agent.name }}</div>

        @if (agents.operationError(); as err) {
          <div class="agents-error">{{ err }}</div>
        }

        @if (isEditing()) {
          <div class="agents-edit-section">
            <div class="agents-md-toolbar">
              <button type="button" class="agents-md-toolbar-btn" title="Bold" (click)="insertMarkdown('edit','**','**','bold')"><b>B</b></button>
              <button type="button" class="agents-md-toolbar-btn" title="Italic" (click)="insertMarkdown('edit','*','*','italic')"><i>I</i></button>
              <button type="button" class="agents-md-toolbar-btn" title="Heading" (click)="insertMarkdown('edit','## ','','heading')">H</button>
              <button type="button" class="agents-md-toolbar-btn" title="Link" (click)="insertMarkdown('edit','[','](url)','link text')">&#128279;</button>
              <button type="button" class="agents-md-toolbar-btn" title="Bullet list" (click)="insertMarkdown('edit','- ','','item')">&#8226;</button>
              <button type="button" class="agents-md-toolbar-btn" title="Numbered list" (click)="insertMarkdown('edit','1. ','','item')">1.</button>
              <button type="button" class="agents-md-toolbar-btn" title="Horizontal rule" (click)="insertMarkdown('edit','\n---\n','','')">&#8212;</button>
              <button type="button" class="agents-md-toolbar-btn" title="Code" (click)="insertMarkdown('edit','`','`','code')">``</button>
              <span class="agents-md-toolbar-sep"></span>
              <button type="button" class="agents-md-toolbar-btn" [class.active]="showEditPreview()" title="Preview" (click)="toggleEditPreview()">&#128065;</button>
            </div>
            @if (showEditPreview()) {
              <div class="agents-md-preview agents-detail-content" [innerHTML]="editPreviewHtml"></div>
            } @else {
              <textarea
                #editTextarea
                class="agents-edit-textarea agents-md-textarea"
                [(ngModel)]="editContent"
                rows="12"></textarea>
            }
            <div class="agents-edit-actions">
              <button
                class="agents-btn-primary"
                [disabled]="agents.isSaving()"
                (click)="saveEdit()">
                {{ agents.isSaving() ? i18n.t('agents.saving') : i18n.t('agents.save') }}
              </button>
              <button class="agents-btn-secondary" (click)="cancelEdit()">{{ i18n.t('agents.cancel') }}</button>
            </div>
          </div>
        } @else {
          <div class="agents-detail-content" [innerHTML]="renderedContent()"></div>
        }
      </div>
    }
    <!-- LIST VIEW -->
    @else {
      <div class="agents-list-toolbar">
        <button class="agents-btn-create" (click)="startCreate()">+ {{ i18n.t('agents.create') }}</button>
        <select class="agents-template-select" (change)="onTemplateSelect($event)">
          <option value="" disabled selected>From template...</option>
          @for (tpl of templates; track tpl.name) {
            <option [value]="tpl.name">{{ tpl.label }}</option>
          }
        </select>
      </div>
      @if (agents.isLoading()) {
        <div class="agents-empty">{{ i18n.t('agents.loading') }}</div>
      } @else if (agents.agents().length === 0) {
        <div class="agents-empty">{{ i18n.t('agents.empty') }}</div>
      } @else {
        <div class="agents-list">
          @for (agent of agents.agents(); track agent.filename) {
            <div class="agents-list-item">
              <button class="agents-list-name" (click)="selectAgent(agent.filename)">
                {{ agent.name }}
              </button>
              <button class="agents-list-run" (click)="runAgent({ name: agent.name, filename: agent.filename, content: '' })" title="{{ i18n.t('agents.run') }}">
                &#9654;
              </button>
            </div>
          }
        </div>
      }
    }
  </div>
</div>
