<div class="agents-panel">
  <div class="agents-header">
    <div class="agents-tabs">
      <button class="agents-tab" [class.agents-tab--active]="activeTab() === 'agents'" (click)="switchTab('agents')">{{ i18n.t('panel.agents') }}</button>
      <button class="agents-tab" [class.agents-tab--active]="activeTab() === 'analytics'" (click)="switchTab('analytics')">{{ i18n.t('panel.analytics') }}</button>
      <button class="agents-tab" [class.agents-tab--active]="activeTab() === 'recommendations'" (click)="switchTab('recommendations')">{{ i18n.t('panel.recommendations') }}</button>
    </div>
    <button class="agents-close" (click)="agents.toggle()" aria-label="Close agents">&times;</button>
  </div>

  <div class="agents-body">
    @if (activeTab() === 'agents') {
      <!-- CREATE VIEW -->
      @if (isCreating()) {
        <div class="agents-create">
          <div class="agents-toolbar">
            <button class="agents-toolbar-btn" (click)="cancelCreate()">{{ i18n.t('agents.cancel') }}</button>
          </div>
          <div class="agents-create-form">
            <input
              class="agents-name-input"
              type="text"
              [(ngModel)]="newAgentName"
              [placeholder]="i18n.t('agents.namePlaceholder')"
              aria-label="Agent filename" />
            <div class="agents-md-toolbar">
              <button type="button" class="agents-md-toolbar-btn" title="Bold" (click)="insertMarkdown('create','**','**','bold')"><b>B</b></button>
              <button type="button" class="agents-md-toolbar-btn" title="Italic" (click)="insertMarkdown('create','*','*','italic')"><i>I</i></button>
              <button type="button" class="agents-md-toolbar-btn" title="Heading" (click)="insertMarkdown('create','## ','','heading')">H</button>
              <button type="button" class="agents-md-toolbar-btn" title="Link" (click)="insertMarkdown('create','[','](url)','link text')">&#128279;</button>
              <button type="button" class="agents-md-toolbar-btn" title="Bullet list" (click)="insertMarkdown('create','- ','','item')">&#8226;</button>
              <button type="button" class="agents-md-toolbar-btn" title="Numbered list" (click)="insertMarkdown('create','1. ','','item')">1.</button>
              <button type="button" class="agents-md-toolbar-btn" title="Horizontal rule" (click)="insertMarkdown('create','\n---\n','','')">&#8212;</button>
              <button type="button" class="agents-md-toolbar-btn" title="Code" (click)="insertMarkdown('create','`','`','code')">``</button>
              <span class="agents-md-toolbar-sep"></span>
              <button type="button" class="agents-md-toolbar-btn" [class.active]="showCreatePreview()" title="Preview" (click)="toggleCreatePreview()">&#128065;</button>
            </div>
            @if (showCreatePreview()) {
              <div class="agents-md-preview agents-detail-content" [innerHTML]="createPreviewHtml"></div>
            } @else {
              <textarea
                #createTextarea
                class="agents-edit-textarea agents-md-textarea"
                [(ngModel)]="newAgentContent"
                aria-label="Agent content"
                rows="12"></textarea>
            }
            @if (createValidationError; as err) {
              <div class="agents-validation-error">{{ err }}</div>
            }
            <button
              class="agents-btn-primary"
              [disabled]="isCreateDisabled"
              (click)="submitCreate()">
              {{ agents.isSaving() ? i18n.t('agents.saving') : i18n.t('agents.createSave') }}
            </button>
          </div>
        </div>
      }
      <!-- DETAIL VIEW -->
      @else if (agents.selectedAgent(); as agent) {
        <div class="agents-detail">
          @if (showDeleteConfirm()) {
            <div class="agents-delete-bar">
              <span class="agents-delete-msg">Delete '{{ agent.name }}'? This cannot be undone.</span>
              <div class="agents-delete-actions">
                <button
                  class="agents-btn-danger"
                  [disabled]="agents.isDeleting()"
                  (click)="confirmDelete()">
                  {{ agents.isDeleting() ? i18n.t('agents.deleting') : i18n.t('agents.deleteYes') }}
                </button>
                <button class="agents-btn-secondary" (click)="cancelDelete()">{{ i18n.t('agents.deleteNo') }}</button>
              </div>
            </div>
          }

          <div class="agents-toolbar">
            <button class="agents-toolbar-btn" (click)="goBack()">{{ i18n.t('agents.back') }}</button>
            <div class="agents-toolbar-right">
              @if (!isEditing()) {
                <button class="agents-toolbar-btn agents-toolbar-run" (click)="runAgent(agent)">&#9654; {{ i18n.t('agents.run') }}</button>
                <button class="agents-toolbar-btn" (click)="startEdit()">{{ i18n.t('agents.edit') }}</button>
                <button class="agents-toolbar-btn agents-toolbar-delete" (click)="requestDelete()">{{ i18n.t('agents.delete') }}</button>
              }
            </div>
          </div>

          <div class="agents-detail-name">{{ agent.name }}</div>

          @if (agents.operationError(); as err) {
            <div class="agents-error">{{ err }}</div>
          }

          @if (isEditing()) {
            <div class="agents-edit-section">
              <div class="agents-md-toolbar">
                <button type="button" class="agents-md-toolbar-btn" title="Bold" (click)="insertMarkdown('edit','**','**','bold')"><b>B</b></button>
                <button type="button" class="agents-md-toolbar-btn" title="Italic" (click)="insertMarkdown('edit','*','*','italic')"><i>I</i></button>
                <button type="button" class="agents-md-toolbar-btn" title="Heading" (click)="insertMarkdown('edit','## ','','heading')">H</button>
                <button type="button" class="agents-md-toolbar-btn" title="Link" (click)="insertMarkdown('edit','[','](url)','link text')">&#128279;</button>
                <button type="button" class="agents-md-toolbar-btn" title="Bullet list" (click)="insertMarkdown('edit','- ','','item')">&#8226;</button>
                <button type="button" class="agents-md-toolbar-btn" title="Numbered list" (click)="insertMarkdown('edit','1. ','','item')">1.</button>
                <button type="button" class="agents-md-toolbar-btn" title="Horizontal rule" (click)="insertMarkdown('edit','\n---\n','','')">&#8212;</button>
                <button type="button" class="agents-md-toolbar-btn" title="Code" (click)="insertMarkdown('edit','`','`','code')">``</button>
                <span class="agents-md-toolbar-sep"></span>
                <button type="button" class="agents-md-toolbar-btn" [class.active]="showEditPreview()" title="Preview" (click)="toggleEditPreview()">&#128065;</button>
              </div>
              @if (showEditPreview()) {
                <div class="agents-md-preview agents-detail-content" [innerHTML]="editPreviewHtml"></div>
              } @else {
                <textarea
                  #editTextarea
                  class="agents-edit-textarea agents-md-textarea"
                  [(ngModel)]="editContent"
                  (ngModelChange)="scheduleDraftSave()"
                  aria-label="Agent content"
                  rows="12"></textarea>
              }
              <div class="agents-edit-actions">
                <button
                  class="agents-btn-primary"
                  [disabled]="agents.isSaving()"
                  (click)="saveEdit()">
                  {{ agents.isSaving() ? i18n.t('agents.saving') : i18n.t('agents.save') }}
                </button>
                <button class="agents-btn-secondary" (click)="cancelEdit()">{{ i18n.t('agents.cancel') }}</button>
              </div>
            </div>
          } @else {
            <div class="agents-detail-content" [innerHTML]="renderedContent()"></div>
          }
        </div>
      }
      <!-- LIST VIEW -->
      @else {
        <div class="agents-list-toolbar">
          <button class="agents-btn-create" (click)="startCreate()">+ {{ i18n.t('agents.create') }}</button>
          <select class="agents-template-select" (change)="onTemplateSelect($event)">
            <option value="" disabled selected>From template...</option>
            @for (tpl of templates; track tpl.name) {
              <option [value]="tpl.name">{{ tpl.label }}</option>
            }
          </select>
        </div>
        @if (agents.agents().length >= 4) {
          <input class="agents-search" [ngModel]="searchQuery()" (ngModelChange)="searchQuery.set($event)" placeholder="Search agents..." aria-label="Search agents" />
        }
        @if (agents.isLoading()) {
          <div class="agents-skeleton">
            @for (i of [1, 2, 3, 4, 5]; track i) {
              <div class="skeleton-row"></div>
            }
          </div>
        } @else if (agents.agents().length === 0) {
          <div class="agents-empty">{{ i18n.t('agents.empty') }}</div>
        } @else {
          <div class="agents-list">
            @for (agent of filteredAgents(); track agent.filename) {
              <div class="agents-list-item">
                <button class="agents-list-name" (click)="selectAgent(agent.filename)">
                  {{ agent.name }}
                </button>
                <span class="agents-priority-dot"
                  [class.priority-high]="agent.priority === 'high'"
                  [class.priority-medium]="agent.priority === 'medium'"
                  [class.priority-low]="agent.priority === 'low' || !agent.priority"></span>
                <button class="agents-list-run" (click)="runAgent({ name: agent.name, filename: agent.filename, content: '' })" title="{{ i18n.t('agents.run') }}">
                  &#9654;
                </button>
              </div>
            }
          </div>
        }
      }
    }

    @if (activeTab() === 'analytics') {
      @defer {
        <app-analytics [embedded]="true" />
      } @loading {
        <div class="agents-skeleton">
          @for (i of [1, 2, 3]; track i) {
            <div class="skeleton-row"></div>
          }
        </div>
      }
    }

    @if (activeTab() === 'recommendations') {
      <div class="recommendations-list">
        @for (rec of recommendations(); track rec.prompt + rec.text) {
          <button class="recommendation-item" (click)="executeRecommendation(rec)">
            <span class="recommendation-icon">{{ rec.icon }}</span>
            <span class="recommendation-text">{{ rec.text }}</span>
            <span class="recommendation-arrow">&#8250;</span>
          </button>
        }
        @if (recommendations().length === 0) {
          <div class="recommendations-empty">{{ i18n.t('recommendations.empty') }}</div>
        }
      </div>
    }
  </div>

  @if (confirmAction(); as action) {
    <div class="agents-confirm-overlay" (click)="confirmAction.set(null)">
      <div class="agents-confirm-dialog" (click)="$event.stopPropagation()">
        <p class="agents-confirm-msg">{{ action.message }}</p>
        <div class="agents-confirm-actions">
          <button class="agents-btn-primary" (click)="action.onConfirm()">Yes</button>
          <button class="agents-btn-secondary" (click)="dismissConfirm()">No</button>
        </div>
      </div>
    </div>
  }

  @if (showInvite()) {
    <div class="agents-invite">
      <div class="agents-invite-title">{{ i18n.t('agents.inviteTitle') }}</div>
      <input type="email" class="agents-invite-input" [(ngModel)]="inviteEmail" [placeholder]="i18n.t('agents.inviteEmailPlaceholder')" aria-label="Invite email address" />
      <textarea class="agents-invite-textarea" [(ngModel)]="inviteMessage" [placeholder]="i18n.t('agents.inviteMessagePlaceholder')" aria-label="Personal message" rows="2"></textarea>
      <button class="agents-btn-primary" [disabled]="!inviteEmail.trim()" (click)="sendInvite()">{{ i18n.t('agents.inviteSend') }}</button>
    </div>
  }
</div>
