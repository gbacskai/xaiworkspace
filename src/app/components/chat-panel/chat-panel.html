<div class="chat-panel">
  <div class="chat-header">
    <div class="chat-header-info">
      <span class="chat-header-title">xAI Workspace</span>
      <span class="chat-header-status"
        [class.chat-header-status--connected]="chat.connectionState() === 'connected'"
        [class.chat-header-status--error]="chat.connectionState() === 'error'">
        @switch (chat.connectionState()) {
          @case ('connected') { {{ i18n.t('chat.connected') }} }
          @case ('error') { {{ i18n.t('chat.disconnected') }} }
          @case ('disconnected') { {{ i18n.t('chat.disconnected') }} }
          @default { {{ i18n.t('chat.connecting') }} }
        }
      </span>
    </div>
    @if (chat.sessions().length > 1) {
      <div class="account-switcher">
        <button class="account-switcher-btn" (click)="toggleAccountMenu()">
          {{ currentAccountLabel() }} <span class="caret">&#9662;</span>
        </button>
        @if (accountMenuOpen()) {
          <div class="account-switcher-menu">
            @for (s of chat.sessions(); track s.chatId) {
              <button class="account-item"
                [class.active]="s.chatId === chat.currentChatId()"
                (click)="selectAccount(s.chatId)">
                {{ s.chatId }}
              </button>
            }
          </div>
        }
      </div>
    }
    <button class="chat-close" (click)="chat.toggle()" aria-label="Close chat">&times;</button>
  </div>

  <div class="chat-messages" #messageList>
    @for (msg of chat.messages(); track msg.id) {
      <div class="chat-bubble"
        [class.chat-bubble--user]="msg.sender === 'user'"
        [class.chat-bubble--bot]="msg.sender === 'bot'"
        [class.chat-bubble--system]="msg.sender === 'system'">
        <span class="chat-bubble-text"
        [class.chat-bubble-text--command]="msg.sender === 'user' && msg.text.startsWith('/')"
        (click)="msg.sender === 'user' && msg.text.startsWith('/') && copyToInput(msg.text)">{{ msg.text }}</span>
        @if (msg.buttons) {
          <div class="chat-buttons">
            @for (row of msg.buttons; track $index) {
              <div class="chat-button-row">
                @for (btn of row; track btn.text) {
                  @if (btn.url) {
                    <a class="chat-btn chat-btn--url" [href]="btn.url" target="_blank" rel="noopener">{{ btn.text }}</a>
                  } @else if (btn.callback_data) {
                    <button class="chat-btn chat-btn--action"
                      [class.chat-btn--back]="btn.callback_data === '__back__'"
                      [class.chat-btn--pay]="btn.text.startsWith('Pay ')"
                      (click)="onCallback(btn.callback_data!, msg)">{{ btn.text }}</button>
                  }
                }
              </div>
            }
          </div>
        }
        @if (msg.file) {
          <button class="chat-btn chat-btn--file" (click)="downloadFile(msg.file!)">{{ msg.file.name }}</button>
        }
      </div>
    }
    @if (chat.messages().length === 0) {
      <div class="chat-empty">{{ i18n.t('chat.empty') }}</div>
    }
  </div>

  @if (commandMenuOpen()) {
    <div class="command-menu">
      @for (cmd of commandMatches(); track cmd.command; let i = $index) {
        <button class="command-item"
          [class.command-item--active]="i === commandSelectedIndex()"
          (mousedown)="selectCommand(cmd)">
          <span class="command-name">{{ cmd.command }}</span>
          <span class="command-desc">{{ cmd.description }}</span>
        </button>
      }
    </div>
  }

  <div class="chat-input-bar">
    <textarea
      class="chat-input"
      [(ngModel)]="messageText"
      [placeholder]="i18n.t('chat.placeholder')"
      (keydown)="onKeydown($event)"
      (input)="onInput()"
      rows="1"></textarea>
    <button class="chat-send"
      [disabled]="!messageText.trim()"
      (click)="send()">
      {{ i18n.t('chat.send') }}
    </button>
  </div>
</div>
